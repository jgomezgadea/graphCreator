<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />

  <!--script src="https://static.robotwebtools.org/EaselJS/current/easeljs.js"></script-->
  <!--script src="https://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script-->
  <!--script src="https://static.robotwebtools.org/roslibjs/current/roslib.js"></script-->
  <script src="../build/easeljs.js"></script>
  <script src="../build/eventemitter2.js"></script>
  <script src="../build/roslib.js"></script>

  <script src="../build/ros2d.js"></script>

  <script>
    /**
     * Setup all visualization elements when the page is loaded.
     */
    var ros;
    var viewer;
    var panView;
    var zoomView;
    var gridClient;

    function init() {
      // Connect to ROS.
      ros = new ROSLIB.Ros({
        url: 'ws://localhost:9090'
      });

      // Create the main viewer.
      viewer = new ROS2D.Viewer({
        divID: 'map',
        width: 308,
        height: 250
      });

      panView = new ROS2D.PanView({
        rootObject: viewer.scene
      })

      zoomView = new ROS2D.ZoomView({
        rootObject: viewer.scene
      })

      // Setup the map client.
      gridClient = new ROS2D.OccupancyGridClient({
        ros: ros,
        rootObject: viewer.scene,
        // Use this property in case of continuous updates			
        continuous: true
      });
      // Scale the canvas to fit to the map
      gridClient.on('change', function () {
        viewer.scaleToDimensions(gridClient.currentGrid.width, gridClient.currentGrid.height);
        viewer.shift(gridClient.currentGrid.pose.position.x, gridClient.currentGrid.pose.position.y);
      });

      // Callback functions when there is mouse interaction with a point
      var clickedPoint = false;
      var selectedPointIndex = null;
      var canMoveMap = false;
      var movedMouse = false;
      var clickedPos = new ROSLIB.Vector3({ x: 0, y: 0 });

      var pointCallBack = function (type, event, index) {
        if (type === 'mousedown') {
          if (event.nativeEvent.shiftKey === true) {
            polygon.remPoint(index);
          } else {
            selectedPointIndex = index;
          }
        }
        clickedPoint = true;
      };

      var lineCallBack = function (type, event, index) {
        if (type === 'mousedown') {
          if (event.nativeEvent.ctrlKey === true) {
            polygon.splitLine(index);
          }
        }
        clickedPoint = true;
      }

      // Create the polygon
      var polygon = new ROS2D.PolygonMarker({
        lineColor: createjs.Graphics.getRGB(100, 100, 255, 1),
        pointCallBack: pointCallBack,
        lineCallBack: lineCallBack
      });

      // Add the polygon to the viewer
      viewer.scene.addChild(polygon);

      viewer.scene.addEventListener('stagemousemove', function (event) {
        movedMouse = true;
        // Move map when it's dragged and ctrl pressed
        if (event.nativeEvent.ctrlKey === true && canMoveMap === true) {
          panView.pan(event.stageX - clickedPos.x, event.stageY - clickedPos.y);
        }
        // Move point when it's dragged
        else if (selectedPointIndex !== null) {
          var pos = viewer.scene.globalToRos(event.stageX, event.stageY);
          polygon.movePoint(selectedPointIndex, pos);
        }
      });

      viewer.scene.addEventListener('stagemouseup', function (event) {
        // Stop moving point when mouse up
        if (selectedPointIndex !== null) {
          selectedPointIndex = null;
        }
        // If we was moving the map
        else if (canMoveMap === true) {
          clickedPos.x = event.stageX - clickedPos.x;
          clickedPos.y = event.stageY - clickedPos.y;
          canMoveMap = false;
        }
        // Add point when not clicked on the polygon ...
        else if (viewer.scene.mouseInBounds === true && clickedPoint === false) {
          // ... only if we aren't doing any other action
          if (event.nativeEvent.shiftKey === false && movedMouse === false) {
            var pos = viewer.scene.globalToRos(event.stageX, event.stageY);
            polygon.addPoint(pos);
          }
        }
        clickedPoint = false;
      });

      viewer.scene.addEventListener('stagemousedown', function (event) {
        movedMouse = false;
        // If ctrl pressed, we can move the map with drag and drop
        if (event.nativeEvent.ctrlKey === true && viewer.scene.mouseInBounds === true) {
          clickedPos.x = event.stageX - clickedPos.x;
          clickedPos.y = event.stageY - clickedPos.y;
          canMoveMap = true;
        }
      })

    }
  </script>
</head>

<body onload="init()">
  <h1>Robotnik 2D map</h1>
  <p>
    How to launch:
  </p>
  <ol>
    <li><tt>roscore</tt></li>
    <li><tt>rosrun map_server map_server /path</tt></li>
    <li><tt>roslaunch rosbridge_server rosbridge_websocket.launch</tt></li>
  </ol>
  <div id="map"></div>
  <p>
    How to use the map:
  </p>
  <ol>
    <li><tt>Click to create a point</tt></li>
    <li><tt>Click and drag to move a point</tt></li>
    <li><tt>Shift+click to delete a point</tt></li>
    <li><tt>Ctrl+click and drag to move the map</tt></li>
  </ol>
</body>

</html>